# 異なるアプリケーションからのアクセス

## どのように異なるアプリケーションと判別されるのか

そもそも「異なるアプリケーション」とは何なのかについて考えてみましょう。

例えば、レストラン予約サイトとGoogleマップが異なるアプリケーションであることは明らかです。
「なぜ違うのか」と聞かれると「そもそもブラウザからアクセスする先が違うから」と答えることができるでしょう。

「アクセスする先が違う」ということを具体的に知る必要があります。

## スキーム

スキームとは、`http://localhost:3000`の`http://`部分を指します。httpの部分はプロトコルでは？と思った方は素晴らしいです。
スキームとは、一般的にHTTPプロトコルの部分を指します。

## ホスト

ホストとは、`http://localhost:3000`の`localhost:`部分や、他には`www.techcamp.jp`の`www`を指します。
これは接続する機器を表していると考えましょう。
`localhost`であれば、ローカル環境に接続するという意味になります。

## ドメイン

ドメインとは、`www.techcamp.jp`の`techcamp.jp`を指します。
こちらは、インターネット上の住所と考えましょう。

## ポート

ポートとは、`http://localhost:3000`の`３０００`部分を指します。
ポートは、それ以前の文字を住所だと表現したときに、部屋番号などに例えられます。

同じホストにアクセスしたとしても、ポートを変えることで複数のソフトへの接続を受け付けることができます。
ローカルで考えてみると、localhost:3000を立ち上げつつ、
localhost:3001を立ち上げれば別々のアプリケーションを同時起動することができます（その場合はrails s -p 3001のようにコマンド実行して起動します）。

「アクセスする先が違う」という意味を言い換えると、「**オリジンが異なるアプリケーション**」を指します。

## Origin(オリジン)

オリジンはWebに関連する知識であり、URLのスキーム（プロトコル）、ホスト（ドメイン）、ポートをまとめた総称です。
具体的には、`http://localhost:3000`や`https://techcamp.jp`を指します。

一見、URLと同じように見えますが、URLの場合はhttp://localhost:3000/hoge/hogeまで該当します。

オリジンは下記の表にある３つの要素から成り立ちます。

| 名称	                 | 例           |
| -------------------- | ------------ |
| スキーム（プロトコル）	     | http://      |
| ホスト（ドメイン）	  	     | localhost:   |
| ポート          	     | 3000         |

アプリ①と②を仮定し、具体例を見てみます。

| アプリ①		                       | アプリ②	                           | 同一オリジンか？		   | 理由                 |
| -------------------------------- | --------------------------------- | ----------------- | -------------------- |
| http://sample.com:3000/hoge	    　 | http://sample.com:3000/huga    　  | 同一オリジン		     | パスのみが異なる        |
| http://sample.com:3000          　 | 	https://sample.com:3000       　  | 同一ではない		     | スキームが異なるため     |
| http://sample.com:3000	        　 | http://test.com:3000           　  | 同一ではない		     | ホストが異なるため       |
| http://sample.com:3000          　 | http://sample.com:8000         　  | 同一ではない		     | ポートが異なるため       |

上記のように、「同一オリジン」とはオリジン（スキーム、ホスト、ポート）が、完全に一致したアプリケーションとなります。
逆にオリジン（スキーム、ホスト、ポート）が１つでも一致しない場合は、「異なるアプリケーション」となります。

そして、異なるアプリケーションに対してアクセスする際の制限に関して`同一オリジンポリシー`と呼ばれるものがあります。

## 同一オリジンポリシー

同一オリジンポリシーは「異なるオリジンのアプリケーションへアクセスする際にセキュリティ面を考慮して制限がかかる仕組み」です。
この制限は、通常Webアプリケーションフレームワークでははじめから設定されています。解除するには別の設定が必要です。  



# 同一オリジンポリシーが有用であるケース

## 同一オリジンポリシーを考慮すべきパターン

同一オリジンポリシーを考慮する必要があるのはAPIを使用するケースです。

例えば、ある会社が運営するWebアプリケーションが、他社が提供している外部APIを使用する時、ほとんどのケースでオリジンが異なります。
この時に同一オリジンポリシーの制限が存在すると、他社のAPIにアクセスすることができないため、API自体を利用することができなくなります。

## 制限をかける理由

制限をかけるのは、異なるオリジンからのアクセスを常に許可してしまうと誰でもAPIを使用できる状態になり、意図しないアクセスに対応できないためです。

実感が湧かないと思うので、ここでは「なぜ同一オリジンポリシーが存在するのか」について具体的なエピソードを用いて説明します。


----------------------------------------------------------------------------------------------

ある日、私は画期的なサービスを思いつきました。

世界中のマップを表示でき、経路検索もできるアプリケーションです。

iOSでリリースし、たちまち人気になりました。しかしながら「地図単体の価値」はさほど高くありませんでした。

そこで、「地図×◯◯」のような状態で初めて価値を発揮すると確信し、グルメサイトなどに地図を表示しないかと営業を始めました。


それに合わせて、地図情報を提供するアプリケーションを作成し、誰でもhttps://map.com/placeにアクセスすればあらゆる地図の情報を取得できるように再開発しました。

公開に利用したサーバーは、想定しているアクセス数で月に10万円程度の費用がかかる見積もりです。


１週間後...サーバーの利用料100万円の請求が届きました。想定では月に10万円程度だったので、非常に困りました。


原因を調べたところ、アプリケーション利用を契約していない会社からも利用され、「アクセス過多」でサーバー費用が想定を超えていることが分かりました。

----------------------------------------------------------------------------------------------

異なるオリジンからアクセスがいつでもできるアプリケーションは、「誰でも使用できる」ということです。
今回、契約した会社以外はアクセスできないよう制限をかけていれば、不正に使用されるケースは免れたでしょう。

さて、今回の題目は「なぜ、同一オリジンポリシーが存在するのか」でしたが、答えは一目瞭然です。

異なるオリジンからのアクセスを常に許可してしまうと誰でもAPIを使用できる状態になり、意図しないアクセスに対応できなくなります。

しかしながら、すべてに制限を掛けてしまうと外部APIが成り立たなくなってしまうので「制限を解除する仕組み」も存在します。

