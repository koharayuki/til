# セッションを狙った攻撃とその対策

セッションが保存されているクッキーを狙った攻撃を、セッションハイジャックと言います。

## セッションハイジャック

XSSなどを用いて、正規利用者ではない者が正規利用者のセッションを取得する攻撃手法です。とくに、クッキーにはセッションを`セッションID`という識別番号を用いて保存します。
このセッションIDを盗み出されると、セッションハイジャックが成立してしまいます。

## セッションID

セッションIDとは、通信中の正規利用者（クライアント）へ付与される、固有の識別情報のことです。ここでは、**正規利用者1人ひとりを識別するために付与される、固有の情報**と捉えておきましょう。

セッションハイジャックが行われた場合、アプリケーション内で正規利用者ができることはほとんど、実行が可能となってしまいます。
なぜなら、セッションにはその正規利用者のログイン情報などが含まれるためです。
その結果、正規利用者の個人情報閲覧、送金や物品購入、なりすましメールの送信やSNSへの犯罪予告など、正規利用者への被害はとても大きくなります。

具体的な攻撃手法としては以下の3つが挙げられます。

- セッションIDの推測
- セッションIDの盗み出し
- セッションIDの強制


# セッションIDの推測によるセッションハイジャック

Webアプリケーションに用いられるセッションIDの生成規則に問題があると、第三者にセッションIDが予測され、悪用されてしまう可能性があります。
以下は、生成規則に問題があるセッションIDです。

- ユーザーIDやメールアドレス
- リモートIPアドレス
- 日時

つまり、セッションIDの推測によるセッションハイジャックとは、外部から参照可能な値を用いてセッションIDを推測する手法と言えます。

### 対策：独自でセッションIDの生成を行わない

推測可能なセッションIDを生成しないためには、独自での生成機構は作らず、フレームワークなどのWebアプリケーション開発ツールを利用することが安全とされています。
主要なアプリケーション開発ツールのセッション管理機構に脆弱性が発見された場合、すばやく指摘・改善されることが期待できるためです。

Ruby on RailsもこのWebアプリケーション開発ツールに含まれます。


# セッションIDの盗み出しによるセッションハイジャック

XSSを用いたセッションハイジャックがこれにあたります。

JavaScriptでは、<script>document.cookie</script>というスクリプトでクッキーの情報が表示できます。
このスクリプトへ更に細工をして、攻撃者側のサーバーに正規利用者のクッキーの情報を送付するようにすると、セッションハイジャックが成立します。

下図のように、仕込まれたスクリプトが発火した時点で、攻撃者に正規利用者（ユーザー）のクッキーが行き渡ります。

![image](https://github.com/koharayuki/til/assets/132040884/b01884d7-0b38-4984-bd2d-d014bf422a14)

また、インターネット環境のセキュリティ対策が不十分であると、正規利用者とサーバーの通信の際にセッションIDが傍受されることがあります。

### 対策①：XSSを防ぐ
XSSの対策を講じることが重要です。

### 対策②：安全なインターネット環境を用いる
インターネット環境の安全性向上のためには、インターネット上の通信を暗号化する仕組みを利用します。このような暗号化の仕組みをSSLと言います。

## SSL（Secure Socket Layer）

SSLとは、インターネット上の通信を暗号化してくれる技術です。これにより、第三者からの情報の盗聴や改ざんを防ぐことができます。

![image](https://github.com/koharayuki/til/assets/132040884/952b13a2-21e8-4097-bbdc-bdad849e2ff0)

したがって、クッキーのような重要な情報をやりとりする際はSSLを使うと安全性を保つことができます。

Renderについては、デフォルトではRenderのドメインを利用しており、`https://＜アプリの名前＞.onrender.com/`となっています。
この状態では、問題なくSSL化されているため安心と言えるでしょう。SSLに対応したWebアプリケーションなどのURLはhttps://から始まります。

しかし、Renderなどのプラットフォームを用いず、独自にサーバーを契約してデプロイを行った場合などは、自身でSSLに対応する必要があります。


# セッションIDを固定することによるセッションハイジャック

ここまでは正規利用者に設定されたセッションIDの推測や、セッションIDを盗み出して利用する手法を紹介しました。ここからは、セッションIDを攻撃者が外部から強制的に固定する方法を学習します。これをセッションIDの固定化といいます。

セッションIDの固定化は以下の手順で行われます。

![image](https://github.com/koharayuki/til/assets/132040884/077b7856-8753-4f2a-91d7-9c15bff9a2bb)

1.攻撃者は普通の利用者としてセッションID(abc123)を取得

2.正規利用者（ユーザー）に対して①で取得したセッションIDを強制

3.正規利用者（ユーザー）は標的アプリケーションにログイン

4.攻撃者は、正規利用者（ユーザー）に強制したセッションID(abc123)を使って標的アプリケーションにアクセスする

セッションとは利用者の状態を保持するために使われていたことを思い出してください。
正規利用者（ユーザー）は攻撃者が強制したセッションで認証が完了しています。そのため、そのセッションを用いてアクセスした攻撃者はすでに認証済みのページにアクセスできます。

### 対策：ログイン後にセッションIDを変更する

セッションIDを固定する方法は多種多様であるため、固定化されないように常に変更し続けることが有効です。
具体的には下図のように、ログイン（認証）が完了した時点でセッションIDを変更するという方法があります。

![image](https://github.com/koharayuki/til/assets/132040884/c1ba32c9-af06-4392-9cff-534671327e52)

そうすることにより、認証前にセッションIDが固定されたとしても、認証後にセッションIDが変わるため、固定されたセッションIDでアクセスしようと試みる攻撃者は認証されず、攻撃は成功しません。

ユーザー管理機能のために利用したdeviseについては、この仕組みを採用しています。したがって、固定化への対策を追加で行う必要はありません。
もし、自身でユーザー管理機能を作成したい場合は、この対策を行う必要があります。

