# データベースシステムを不正に操作する攻撃

アプリケーションのSQLの不備を利用して、データベースシステムを不正に操作されることがあります。

このような攻撃方法を`SQLインジェクション`と言います。

## SQLインジェクション

「Webページのテキスト入力欄」や「URL」などにSQL文の断片を埋め込むことで、データベースを改ざんしたり不正に情報を入手する手法のことです。

入力フォームから送信した値により、アプリケーションが本来想定しないSQL文を実行させ、攻撃を行います。

![image](https://github.com/koharayuki/til/assets/132040884/6435df2c-4b53-4efb-b39a-8c1956c42e09)

例えば、フォームを送信するときの文章の中に、ユーザーの権限を変更するようなSQL文を仕込んで送信します。
すると、サーバーサイドでそのSQL文が実行され、ユーザー権限が変更されてしまうような処理が行われます。  


# SQLインジェクションの対策

## 一般的なSQLインジェクションの対策方法

この方法は、サーバーサイドのコードファイルに直接SQL文を記述し、データベースとのやりとりの機能を実装する場合の対策方法です。
Ruby on Railsを学んで、whereやfind、createなどのActiveRecordのメソッドを用いてデータを取得、保存してきた方々においてはあまり馴染みのない方法と言えます。

SQLインジェクションの脆弱性を解消する一般的な対策方法としては、以下の2つが挙げられます。

### 対策①：意味のある文字列の変換

基本的な対策としてあげられるものが、SQLにおいて意味を持つ特殊文字のエスケープです。SQL文中では「'」が文字列の終端を意味していることがポイントです。

たとえば、データベース内に格納されたuser_idとpasswordが一致すると、ログインなどの認証を認めるアプリケーションを考えてみましょう。

ここで、認証に用いられるSQL文は以下になります。

```SQL
-- $uid（user_id）と$pwd（password）はユーザーのフォームの入力値
SELECT * FROM users WHERE user_id='$uid' AND password='$pwd'
```

ここに、以下のように入力します。

```SQL
$uid  tarou
$pwd  ' OR 'A'='A
```

すると前述のSQL文は以下のようになります。

```SQL
SELECT * FROM users WHERE user_id='tarou' AND password='' OR 'A'='A'
```

もし、特殊文字である「'」をエスケープしていなかった場合、WHERE句の中では`user_id='tarou'` に加え、`password=''`と`'A'='A'`の2つの条件をORで判定することになります。

この`password=''`と`'A'='A'`はORでつながっているため、どちらかがtrueの場合は認証が認められてしまいます。
`'A'='A'`は確実にtrueのため、user_idとpasswordが一致していなくても、user_idだけ正しければ認証が通ってしまいます。

しかし、特殊文字をきちんとエスケープした場合はユーザーからの入力の「'」は単なる文字列として扱われるため、passwordに対する入力が`'OR'A'='A'`という一連の文字列となります。
このようなパスワードを設定していない限り、password不一致となるため認証は認められません。

実際にエスケープを行う場合は、フォームから「'」を含む文字列が送信された場合に、別の記号で置き換えるような実装をすることで実現できます。

### 対策②：より厳格なSQL文の生成

ユーザーからの値をSQLへ反映する前に、SQL文の構造を確定する仕組みをとることで、より厳格に対策できます。
SQL文確定後にユーザーからの値を入れて実行するため、ユーザーの入力値によってSQL文が変更されることはありません。

先ほどの例を用いると、データベースに対する処理を行う前に、以下のSQLを用意しておきます。

```SQL
SELECT * FROM users WHERE user_id=? AND password=?
```

ここで、user_idとpasswordの値として「?」が使われており、これを`プレースホルダー`といいます。

###  プレースホルダー

プレースホルダーはユーザーの値が入力されるまでの一時的な仮引数のようなものです。あらかじめ確定したSQLにおいて、可変の値が入力される箇所に配置します。

このようにプレースホルダーを用いて設定すれば、「usersテーブルにおいてuser_idとpasswordの組み合わせが一致するかどうかを判定できる」という構文を事前に確定することができます。
この後ユーザーからどのような値が入力されようとも、上記の構文の中でSQLが実行されることになり、SQLインジェクションを防ぐことが可能です。

すなわち、passwordとして`'OR'A'='A'`と入力をしても、これらは単純な文字列として認識されます。

![image](https://github.com/koharayuki/til/assets/132040884/542612fe-b4a2-4827-a28d-481e3b50df6c)  


# Ruby on RailsにおけるSQLインジェクションの対策方法

Ruby on Railsにおいて、`ActiveRecordのメソッドを使用する場合はSQLインジェクションが問題になることはほとんどありません。`
したがって、これまで作成したアプリケーションでは対策ができていると言っていいでしょう。

しかし、ActiveRecordの発行するSQL文では、アプリケーションの機能として要件を満たせない場合があります。そういった場合は直接SQL文を記述しなければなりません。

この時に使われるのが過去のカリキュラムでも登場した、SQL文を直接書いてレコードを取得するメソッドfind_by_sqlです。
そして、このfind_by_sqlメソッドを使用する際にSQLインジェクションの脆弱性が潜んでいます。

以下はusersテーブルから全てのレコードを取得する処理についてfind_by_sqlメソッドを使った例です。ActiveRecordとは異なり直接SQL文を記述します。

```SQL
User.find_by_sql('select * from users')
```

実際にfind_by_sqlメソッドにSQLインジェクションの脆弱性が潜んでいることを、検索機能付きのPicTweetを例にしてみます。
今回はツイートの検索機能に、SQLインジェクションの脆弱性を仕込んでみます。

```ruby
def self.search(search)
  if search != ""
    Tweet.find_by_sql("select * from tweets where text like '%#{search}%' ")
    # Tweet.where('text LIKE(?)', "%#{search}%") 削除
  else
    Tweet.all
  end
end
```

 localhost:3000にアクセスします。
 ※もしデータが存在していないようであれば、適当に複数データを用意しておきます。

###  SQLインジェクションを実行する

次に、検索のテキストボックスに以下のように入力して実行します。

```SQL
' OR 'A'='A
```

すると以下のように、存在するtweetがすべて検索されてしまいます。

![image](https://github.com/koharayuki/til/assets/132040884/752aa094-2198-4ba3-8b63-c9cdde296eef)

ここで先ほどテキストボックスに入力した記述を思い出してみましょう。
この記述は最初のシングルクォーテーションでプログラム側のSQL文を終了させ、OR 'A'='Aの部分でtrueにすることによって、処理を行います。よってすべてのツイートが表示されているということになります。

このように外部からの入力でSQL文を実行されては非常に危険です。そこで、先ほど紹介したプレースホルダーを使い外部からのSQL文の実行を防ぎましょう。

###  SQLインジェクションの対策

earchメソッドを以下のように編集します。

```ruby
def self.search(search)
  if search != ""
    search = "%#{search}%"
    Tweet.find_by_sql(["select * from tweets where text like ? ", search])
  else
    Tweet.all
  end
end
```

searchという変数に入力値である仮引数searchを代入し、それをLIKE句で検索するために%で囲っています。
find_by_sql内ではプレースホルダー`?`をいれることによって、ユーザーの入力を適用する前にSQL文を確定します。`[]`はプレースホルダーを利用するために用いています。

それでは、先ほど入力したようにテキストボックスに以下を入力してみましょう。

```SQL
' OR 'A'='A
```

すると今度は以下のように検索結果になにも表示されていないはずです。

![image](https://github.com/koharayuki/til/assets/132040884/e9a5f9e4-0777-481c-a827-c464374fa415)

これは入力値である「' OR 'A'='A」が単純な文字列として扱われるためです。tweetの中に「' OR 'A'='A」と一致するものがなければ検索結果として出力されません。

このようにプレースホルダーを使うことによって、SQL文へ入力値を適用する前に確定することができます。
したがって、その後入力されるものがSQLインジェクションの脆弱性を突く攻撃コードだったとしても、単純な文字列として扱われるため安全になります。

