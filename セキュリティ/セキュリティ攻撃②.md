# 重要な処理に対する攻撃

Webアプリケーションには、いくつかの重要な処理が存在します。たとえば、ECサイトのクレジットカードでの決済やメールの送信、パスワードの変更などです。
このような重要な処理を、正規利用者になりすまして攻撃者が行うことができてしまう攻撃を`CSRF`と言います。

## CSRF（Cross Site Request Forgery）

攻撃者がユーザーのログイン情報を盗み出す（セッションハイジャック）など、脆弱性のあるWebアプリケーションに対して正規利用者になりすましてリクエストを送る攻撃のことを言います。

なりすましのリクエストは不正なリクエストであり、この不正なリクエストを判別できないWebアプリケーションは、CSRFの脆弱性があると言えます。
CSRFの脆弱性が存在すると、主に以下のような被害を受ける可能性があります。

- 利用者アカウントが不正利用される
- 利用者のパスワードやメールアドレスが変更される
- 利用者の所持している金銭が利用される

CSRFは下図のような仕組みで行われます。

![image](https://github.com/koharayuki/til/assets/132040884/27d55301-cd21-4546-841a-1d868e1d2e48)

### ①攻撃者は、ユーザーの情報を盗み出す悪意のあるWebサイトを用意する

攻撃者はあらかじめ、ユーザーの情報を盗み出すためのWebサイトを用意しておきます。

#### ②、③ユーザーが脆弱性のあるWebアプリケーション上でログインした状態で、悪意のあるWebサイトのリンクをクリックしてしまう

ユーザーはログインをした状態で、脆弱性のあるWebアプリケーション上にある投稿などのリンクをクリックします。
このリンクが、攻撃者があらかじめ用意したWebサイトであると、そのログイン情報が抜き取られてしまい、セッションハイジャックが成立します。

### ④攻撃者は抜き出したログイン情報をもとに、脆弱性のあるWebアプリケーションへ不正なリクエストを行う

抜き出したログイン情報をもとに、ユーザーになりすまして不正なリクエストを行います。
脆弱性のあるWebアプリケーションはこのリクエストが不正なものかどうか判別できません。この不正なリクエストは、商品の購入などの重要な処理であることが多いです。

このようにして、CSRFは成立します。**「別のサイトを経由して、不正なリクエストを行う」ことから「クロスサイト（サイトをまたいだ）リクエストフォージェリ（リクエストの偽装）」と呼ばれます**。

XSSとCSRFは似ているので区別がしにくいですが、以下のように脆弱性のある場所が異なります。

![image](https://github.com/koharayuki/til/assets/132040884/c36ac82e-720c-4591-8b66-73ba84fc7abc)


XSSはクライアント側の脆弱性であり、Webアプリケーションがクライアント側へ表示するデータについて対策を行う必要があります。
一方、CSRFはサーバーサイド側の脆弱性であり、Webアプリケーションのサーバーサイドにおいて受け取るリクエストへの対策をする必要があります。

どちらかの対策をすればいいということではなく、総合的に対処することが重要です。  


# CSRFの対策

## CSRF対策を行うべきリクエスト

CSRFの対策として重要なのは、実装するWebアプリケーションの、どのリクエストに対して脆弱性対策が必要なのかを知ることです。CSRF対策はすべてのリクエストに行う必要はありません。

対策が必要なリクエストは、他ユーザーから勝手に実行されては困るようなリクエストです。たとえば、ECサイトの物品購入処理や、パスワード変更など個人情報編集更新のリクエストが挙げられます。

![image](https://github.com/koharayuki/til/assets/132040884/2aebda00-76d7-4599-99c9-2a78abec667e)

機能一覧の中でCSRFの対策が必要なリクエストは、上図の中で星を付けた部分だけです。具体的には、HTTPメソッドがPOSTやDELETEなどの、データベースの情報を書き換えるためのリクエストです。

## 正規ユーザーからのリクエストか判別して対策する

### 対策①：パスワードの再入力

こちらは文字通り重要な処理が確定する前に、再度パスワードを入力してもらいます。
これはCSRF対策の他にも物品の購入などに先立って、利用者の意思の念押しをしたり、共用のPCにおいて正規の利用者以外の利用者が、重要な処理を実行するのを防いだりする効果があります。

CSRFの攻撃対象としてとりあげた、パスワード変更に関わるリクエストにも、現在のパスワードを再入力させることによりCSRF攻撃を防ぐことが可能です。

※ただし、対策が必要なページ以外でパスワードの再入力を求めるページが複数あると煩雑なアプリケーションになってしまうため、注意が必要です。

### 対策②：リクエストへのトークン（秘密情報）の埋め込み

登録画面や注文確定画面などのCSRF対策が必要なページに対して、攻撃者が知り得ない**トークン**を要求するようにすれば、不正リクエストによる重要な処理が実行されることはありません。

##  トークン

トークンとは、1度だけ使用可能なパスワードのことです。ユーザーの認証などに用いられるケースが多くあります。ここでは、**ユーザーの認証に用いられる秘密情報**と捉えておきましょう。
このトークンは、ユーザーのブラウザ上のみに保管されるものです。

![image](https://github.com/koharayuki/til/assets/132040884/cfa45234-6c6d-4bc8-956e-d6884c1dc927)

Ruby on Railsのフォームのヘルパーメソッドは、この対策を行っています。ターミナルを見てみると、paramsに以下のような情報が含まれていることがわかります。

![image](https://github.com/koharayuki/til/assets/132040884/41e66210-45f9-49b7-a3f8-8b8be7d21f3a)

これは送信者のブラウザで保存されたトークンであり、他のユーザーから同様のリクエストをするとトークンが異なります（またはトークンが存在しません）。
このトークンはログイン情報と照らし合わせることができるため、不正なリクエストかどうかを判別することができます。

また、このトークンが存在するのは、POST、DELETE、PATCH、PUTなどのHTTPメソッドのときのみです。そのため、重要な処理についてはこれらのHTTPリクエストのメソッドになるようにする必要があります。

例えば、投稿時に使用するアクションはcreateアクションですが、無理やりこのcreateアクションにGETで送付するようなルーティングを設計することをしてはいけません。

※厳密には、DELETE、PATCH、PUTのHTTPメソッドは、Ruby on RailsはPOSTのHTTPメソッドとして読み替えます。一部のブラウザはDELETE、PATCH、PUTのメソッドをサポートしていないためです。
ただし、重要なこととしては、**XSS脆弱性やセッションハイジャック脆弱性が存在すると、このトークンについても抜き出されてしまい、CSRF対策が無駄になってしまうということです。**
重ねてですが、セキュリティ対策はあらゆる面で総合的に行う必要があります。

