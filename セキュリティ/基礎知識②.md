## JavaScriptによるセキュリティ攻撃

JavaScriptはクライアントサイドで動くプログラミング言語です。
すなわち、何らかの方法で悪意のあるJavaScriptのプログラムを、ユーザーがWebアプリケーションを表示したブラウザに埋め込めば、ユーザーにそのプログラムを実行させることができてしまいます。

![image](https://github.com/koharayuki/til/assets/132040884/f32bfef2-6b7c-449b-8e7b-e81f9e49c6cb)

JavaScriptを埋め込まれてしまうような攻撃を許すWebアプリケーションは、この攻撃に対する脆弱性があると言えます。
そして、悪意のあるプログラムを脆弱性のあるWebアプリケーション上で実行させるような、JavaScriptを利用した攻撃方法を`XSS`と言います。

## XSS（Cross Site Scripting）

XSSとは、攻撃者が脆弱性のあるWebアプリケーション上に、悪意のあるJavaScriptのプログラム（スクリプト）を埋め込み、そのサイトの利用者を攻撃する手法です。

「スクリプトを埋め込む」とは、ユーザーがブラウザ上で表示するHTML中に、JavaScriptのプログラムを埋め込むことを言います。例えば、以下のようなHTMLがあったとします。

```index.html
<!DOCTYPE html>
<html>
<div>
  こんにちは
</div>
</html>
```

この状態では、ブラウザでは以下のような表示になるはずです。

![image](https://github.com/koharayuki/til/assets/132040884/5b60ed43-9fcd-49c6-958e-71aa0bdc3e93)

一方、何らかの方法で以下のようにJavaScriptを、表示するHTML中に埋め込まれてしまったとします。

```index.html:不正なスクリプトが埋め込まれたHTML
<!DOCTYPE html>
<html>
<div>
  こんにちは
  <script>alert("不正なスクリプトです")</script>
</div>
</html>
```

すると、このようにブラウザを開いた瞬間にアラートが表示されるようになりました。

![image](https://github.com/koharayuki/til/assets/132040884/fbe97fe0-efe1-47cc-a979-92f40941374d)

このように、悪意のあるスクリプトをWebアプリケーションを表示したときに実行させることをゴールとした攻撃がXSSです。
「クロスサイトスクリプティング」のうち、**スクリプトを埋め込んで実行させることが「スクリプティング」に該当します**。

今回は例として、アラートを表示するスクリプトを埋め込みました。しかし、**実際はユーザーの個人情報などを、悪意のある人のサーバーなどへ送付するスクリプトが埋め込まれることが多いです**。


# XSSの種類

## 反射型XSS

ユーザーが悪意のあるURLをクリックすると、脆弱性のあるWebアプリケーション上でスクリプトが実行されるようにする手法です。

![image](https://github.com/koharayuki/til/assets/132040884/af9339b9-44c5-4b2d-ba7e-2e53686ba9e3)

1.ユーザーにURLをクリックさせる

攻撃者が、ユーザーに悪意のあるURL（脆弱性のあるWebアプリケーションへ遷移するURLに細工をしたもの）をクリックさせます。
ユーザーにクリックさせる方法としては、メールで送付したり、掲示板などに書き込んだりすることがあります。

2.ユーザーがクリックすると脆弱性のあるWebアプリケーション上でスクリプトが動く

上記の悪意のあるURLには、脆弱性のあるWebアプリケーション上で発火するスクリプトが仕込まれています。
そして、ユーザーが脆弱性のあるWebアプリケーションのページを開くと、そのスクリプトが発火します。

3.スクリプトが発火すると、攻撃者のサーバーへ個人情報が送られる

直前のステップで発火したスクリプトは、個人情報を抜き取るようなものでした。クリックしたユーザーの個人情報が攻撃者のサーバーへ記録されてしまいました。

この様に、URLをクリックしてレスポンスがあると、即座にスクリプトが実行されることから、「反射型」と呼ばれます。

また、上図のように別のサイト（またはメールなど）から、脆弱性のあるWebアプリケーションへ遷移したあとにスクリプトが実行されます。
**これが「クロスサイトスクリプティング」の「クロスサイト（Webサイト間をまたぐ）」を意味します**。

## 格納型XSS

1.攻撃者が、脆弱性のあるWebアプリケーションにスクリプト付きの投稿をする
フォームからコンテンツを投稿する際に、スクリプトを埋め込んで投稿をします。

2.ユーザーが、その投稿のあるページを訪れるとスクリプトが発火する
スクリプトが埋め込まれた投稿のページを開くと、そのスクリプトが発火します。または、画像にマウスを合わせるとスクリプトが発火するような仕掛けになっていることもあります。

2.スクリプトが発火すると、攻撃者のサーバーへ個人情報が送られる
直前のステップで発火したスクリプトは、個人情報を抜き取るようなものでした。ユーザーの個人情報が攻撃者のサーバーへ記録されてしまいました。

このように、脆弱性のあるWebアプリケーションにスクリプトを格納し、ユーザーが訪れたタイミングで発火するようになっていることから「格納型」と呼ばれます。


# XSSの対処

このXSSは現在も多く事例が報告される攻撃です。脆弱性を突く攻撃の被害はこのXSSに起因するものが最も多くの割合を占めています。
したがってXSSへの対処は、最優先で考えるべきセキュリティ対策と言えるでしょう。

## XSSの主要な対処法

XSSが発生する主要因として、フォームから入力されたスクリプトタグ（`<script>...</script>`）などが、スクリプトとしてそのままブラウザに反映されてしまっていることがあげられます。

したがって、XSSを防ぐためには、HTMLにおいて意味を持つ「"」や「<」を何らかの別の文字列に変換します。この変換する際に用いられる記法を**文字参照**と言います。

### 文字参照

文字参照とは、ブラウザ上で表示できない特殊文字を表記する際に用いられる記法です。
例えば、HTML中に「<」もしくは「>」と記述すると、この2つはタグの「始まり」「終わり」と認識されてしまいます。これらのHTML要素を表すタグは、標準では文字列として表示されません。

これらの特殊文字を文字列としてブラウザ上に表示するためには、文字参照を用います。

| 変換前	  | 変換後            |
| ------- | ---------------- |
| <			  | & lt;            |
| >		    | & gt;            |
| &			  | & amp;           |
| "			  | & quot;          |
| '			  | & #39;           |

上の表は、XSSの対策をする際に変換すべき特殊文字の一覧です。これらの特殊文字を文字参照に変換して表示すれば、外部から埋め込まれたスクリプトが実行されることはありません。

## Ruby on Railsにおける対処法










