# 検索機能の挙動    
      
- 様々な条件で商品の検索をかけることができる

![image](https://github.com/koharayuki/til/assets/132040884/55b77404-2156-4e01-b1c0-f48a3a6b6cfe)   
   
※サンプルアプリを使って実装過程を辿ります。

![image](https://github.com/koharayuki/til/assets/132040884/37fed2b8-74ca-44b6-bf08-53ed6866b5bb)

# 検索機能の実装

## Gemを導入する

検索機能を実装するにあたって、`ransack`というGemを導入します。

## ransack

ransackとは、検索機能の実装を実現できるGemです。
Gemfileの最下部へ以下を記述し、インストールします。

【Gemfile】
```
gem 'ransack'
```

【ターミナル】
```
% bundle install
```

## ルーティングを設定する

今回、検索機能は検索専用のページを作成して、そこで行うようにします。
また、検索専用のページは既にcloneしたアプリの中に、`app/views/items/search.html.erb`という名前で用意されています。
そのため、ここではその用意されたビューファイルが表示できるよう、ルーティングを設定します。

###  検索ページまでのルーティングを設定する

【config/routes.rb】
```ruby
Rails.application.routes.draw do
  devise_for :users
  root "items#index"
  resources :items, only: [:new, :create, :show, :edit, :update] do
    collection do
      get 'search'
    end
  end
end
```

collectionオプションを使用して、itemsコントローラー内のsearchアクションへ繋がるルーティングを設定しました。

### コントローラーにsearchアクションを記述する

itemsコントローラー内のsearchアクションへ繋がるルーティングを設定できたので、次はsearchアクションを記載します。

【app/controllers/items_controller.rb】
```ruby
# 中略

  def update
    if @item.update(item_params)
      redirect_to root_path
    else
      render :edit
    end
  end

  def search
    @q = Item.ransack(params[:q])
    @items = @q.result
  end

  private
  def item_params
    params.require(:item).permit(:name, :image, :category_id, :price).merge(user_id: current_user.id)
  end

# 中略
```

それぞれ以下のような役割を持った記述になります。
ransackを導入した際に使用することが多い記述となります。

| 記述           | 意味                                                 |
| ------------- | ---------------------------------------------------- |
| ransack   	  | 検索オブジェクトを生成する                                  |　
| params[:q]	  | ransackを使用したフォームから送られてくるパラメーターを受け取る     |　
| result    	  | 検索結果を取得する                                       |　　　　

   　
#検索ページへの導線を設ける

検索ページを開きやすいように、トップページに検索ページへのリンクを設けます。

###  トップページに検索ページへのリンクを設ける

【app/views/items/index.html.erb】
```erb
<%= render "shared/header" %>
<h3>トップページ</h3>
<h3><%= link_to '商品出品', new_item_path%></h3>
<h3><%= link_to '商品検索', search_items_path%></h3>
<% @items.each do |item| %>
  <div class="posted-content">
    <%= image_tag item.image %><br>
    <%= item.name%><br>
    <%= link_to '詳細', item_path(item.id)%>
  </div>
<% end %>
```




