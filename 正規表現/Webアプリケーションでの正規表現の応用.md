# Ruby on Railsにおけるバリデーションへの応用

Ruby on Railsでもよく使われる以下の3つを例に挙げて解説します。

- 郵便番号
- 全角かな/カナ漢字の区別
- passwordの英数混合の判断

## 郵便番号について

郵便番号は、3桁の数字とハイフンと4桁の数字で構成されています。ユーザーが正しくハイフンが記入された正しい形式で郵便番号を入力しているかを判別する方法です。

この郵便番号を正規表現らしく言い換えると、先頭に3桁の数字、そしてハイフン、末尾に4桁の数字 となります。

```irb
irb(main):001:0> postal_code = "150-0044"

irb(main):002:0> postal_code.match(/\A\d{3}[-]\d{4}\z/)
=> #<MatchData "150-0044">
```

以下の3つについて解説します。

- {n}
- \A
- \z

##  {n}

直前の文字が n 回出現する場合にマッチします。
例えば、a{5}は、「『a』という文字が5回出現するものにマッチする」という意味になります。
今回はハイフンを挟んでd{3}とd{4}なので、ハイフン前は「数字が3回出現するものにマッチする」、ハイフン後は「数字が4回出現するものにマッチする」という意味になります。

## \A

\Aの直後に置いた文字を、文字列の先頭に持つ場合にマッチします。

今回は\A\d{3}としているので、文字列の先頭に3桁の数字があるとマッチします。postal_codeの先頭は150ですので正しくチェックできています。

## \z

\zの直前に置いた文字を、文字列の末尾に持つ場合にマッチします。

今回は\d{4}\zとしているので、文字列の末尾に4桁の数字があるとマッチします。postal_codeの末尾は0044ですので正しくチェックできています。

モデルには、実際には以下のように記述してバリデーションを設けます。

```ruby:Railsのモデル
validates :postal_code, format: { with: /\A\d{3}[-]\d{4}\z/, message: 'を入力してください' }
```

## 全角かな/カナ漢字の区別について

全角かな/カナ、もしくは漢字を区別するためには、アルファベットをチェックするときに使った[a-z]のように表現します。

```irb
irb(main):001:0> full_name = "山田はな子"

irb(main):002:0> full_name.match(/\A[ぁ-んァ-ヶ一-龥々ー]+\z/)
=> #<MatchData "山田はな子">

irb(main):003:0> full_name = "田中メアリー"

irb(main):004:0> full_name.match(/\A[ぁ-んァ-ヶ一-龥々ー]+\z/)
=> #<MatchData "田中メアリー">

irb(main):005:0> full_name = "yamadaハナ子"

irb(main):006:0> full_name.match(/\A[ぁ-んァ-ヶ一-龥々ー]+\z/)
=> nil
```

##  [ぁ-んァ-ヶ一-龥々ー]

かな/カナ、または漢字についても[a-z]同様に[ぁ-んァ-ン一-龥]と表現することで、「ぁ」から「ん」まで、「ァ」から「ン」まで、「一」から「龥」までの文字でチェックを行います。
これらの文字の範囲は、Unicodeにおける範囲であり、上記の範囲が一般的に指定されます。ただし、[ぁ-んァ-ン一-龥]と表現すると、「ヴ、ヵ、ヶ、々」という文字が弾かれてしまいます。
なぜなら、utf-8文字コード上で「ヴ」「ヵ」「ヶ」はカタカナ「ン」の後に配列されているためです。そのため「ァ-ヶ」と記載しています。

また「々」はutf-8文字コード上で記号として認識されているため、別途「々」の指定を追加する必要があります。
そのため、[ぁ-んァ-ン一-龥]ではなく、[ぁ-んァ-ヶ一-龥々]と表現することで、あらゆる日本語に対応する言葉ができます。

さらに、長音記号が含まれた文字列を区別する場合を考えましょう。例えば「メアリー」や「ジョニー」のような文字列です。
このような長音を区別する場合は、[ぁ-んァ-ヶ一-龥々]の末尾に「ー」を追記して、`[ぁ-んァ-ヶ一-龥々ー]`と記載します。

```irb
irb(main):003:0> full_name = "田中メアリー"

irb(main):004:0> full_name.match(/\A[ぁ-んァ-ヶ一-龥々ー]+\z/)
=> #<MatchData "田中メアリー">
```

これらを踏まえて、再度、例のコードを確認します。
今回は名前全体がかな/カナ/漢字であるかをチェックしたいので、先に出てきた\Aと\zと+を同時に用いて、先頭から末尾までかな/カナ/漢字である場合にのみマッチします。
3つ目のチェックには先頭にyamadaとアルファベットを使用していますので、マッチしておらずnilが返ってきています。

```irb
irb(main):005:0> full_name = "yamadaハナ子"

irb(main):006:0> full_name.match(/\A[ぁ-んァ-ヶ一-龥々ー]+\z/)
=> nil
```

これにより、正しく正規表現で区別できていることがわかります。

モデルには、実際には以下のように記述してバリデーションを設けます。

```ruby:Railsのモデル
with_options presence: true, format: { with: /\A[ぁ-んァ-ヶ一-龥々ー]+\z/, message: '全角文字を使用してください' } do
  validates :first_name
  validates :last_name
end
```

## passwordの英数字混合の判断について









